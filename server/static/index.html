<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <style type="text/css">
    body { font-family: sans-serif; }
    dt { font-weight: bold; }
		img { display: block; }
  </style>
</head>
<body>
	<h1>Hello</h1>

	<section>
    <dl>
      <dt>Connected</dt><dd data-connect>false</dd>
			<dt>Playlist</dt><dd data-playlist></dd>

			<dt>Track</dt><dd data-id></dd>
      <dt>Artist</dt><dd data-artist></dd>
      <dt>Title</dt><dd data-title></dd>
      <dt>Votes</dt><dd data-votes></dd>
      <dt>Progress</dt><dd data-progress></dd>
    </dl>
    <button data-pause>pause</button>
    <button data-play>play</button>
		<img data-img>
  </secton>

  <script src="/socket.io/socket.io.js"></script>
  <script>
		const EventTypeEnum = {
		  CONNECTION: 'connection',
		  CONNECT: 'connect',
		  USER_ENTER: 'user.enter',
		  PLAYLIST_PLAY: 'playlist.play',
		  PLAYLIST_PAUSE: 'playlist.pause',
		  PLAYLIST_TRACK_UPVOTE: 'playlist.track.upvote',
		  PLAYLIST_TRACK_VETO: 'playlist.track.veto',
		  DISCONNECT: 'disconnect',
		  PLAYLIST_TRACK_START: 'playlist.track.start',
		  PLAYLIST_TRACK_PROGRESS: 'playlist.track.progress',
		  PLAYLIST_END: 'playlist.end',
		  USER_UPDATE: 'user.update'
		};

		function http(url) {
			var p = new Promise(function(resolve, reject) {
				var req = new XMLHttpRequest();
				req.addEventListener('load', function() {
					resolve(this.response);
				});
				req.addEventListener('error', function(err) {
					console.error(err);
					reject(err);
				});
				req.responseType = 'json';
				req.open('GET', url);
				req.send();
			});
			return p;
		}

    var playlist = document.querySelector('[data-playlist]');
    var id = document.querySelector('[data-id]');
    var artist = document.querySelector('[data-artist]');
    var title = document.querySelector('[data-title]');
    var votes = document.querySelector('[data-votes]');
    var progress = document.querySelector('[data-progress]');
    var connect = document.querySelector('[data-connect]');
    var img = document.querySelector('[data-img]');

		var play = document.querySelector('[data-play]');
		var pause = document.querySelector('[data-pause]');
		play.disabled = true;
		pause.disabled = true;

		function togglePlay(isPlaying) {
			play.disabled = isPlaying;
			pause.disabled = !isPlaying;
		}

		var host = document.location.protocol + '//' + document.location.host;
    var socket = io(host);

    socket.on(EventTypeEnum.CONNECT, (data) => {
      console.log('connect', data);
			var userId = '56428fd8c24016da78639ef5';
      socket.emit(EventTypeEnum.USER_CONNECT, userId);
      connect.innerHTML = 'true';

			http('/api/playlists/563abe30814e16cea04a4507')
				.then(function(response) {
					playlist.innerHTML = response._id;
					togglePlay(false);
					// document.body.innerHTML = JSON.stringify(response, null, 2);
				});
    });

    socket.on(EventTypeEnum.PLAYLIST_TRACK_START, (data) => {
      console.log('track:start', data);
      id.innerHTML = data.track._id;
      artist.innerHTML = data.track.artists[0].name;
      title.innerHTML = data.track.name;
      votes.innerHTML = data.upVotes.length;
			togglePlay(true);

			http('/api/track/' + data.track._id + '/artwork')
				.then((response) => img.src = response[0].url);
    });

    socket.on(EventTypeEnum.PLAYLIST_TRACK_PROGRESS, (track, data) => {
      var currentTime = data.currentTime;
      var duration = data.duration;
      var percent = Math.floor(data.progress * 100);
      progress.innerHTML = currentTime + ' / ' + duration + ' (' + percent + '%)';
    });

		socket.on(EventTypeEnum.PLAYLIST_TRACK_UPVOTE, (data) => {
			console.log('track:upvote', data);
			if (data.track._id === id.innerHTML) {
				votes.innerHTML = data.upVotes.length;
			}
		});

    socket.on(EventTypeEnum.PLAYLIST_END, (data) => {
      console.log('playlist:end', data);
      artist.innerHTML = '';
      title.innerHTML = '';
      votes.innerHTML = '';
      progress.innerHTML = '';
    });

    socket.on(EventTypeEnum.USER_UPDATE, (users) => console.log('users', users));
    socket.on(EventTypeEnum.PLAYLIST_PAUSE, () => togglePlay(false));
    socket.on(EventTypeEnum.PLAYLIST_PLAY, () => togglePlay(true));

    pause.addEventListener('click', () => socket.emit(EventTypeEnum.PLAYLIST_PAUSE));
    play.addEventListener('click', () => socket.emit(EventTypeEnum.PLAYLIST_PLAY, playlist.innerHTML));
  </script>
</body>
</html>
